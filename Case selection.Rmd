---
title: "Case selection"
author: "Anthony Staines & Anne O'Farrell"
date: "`r Sys.Date()`"
output:
  pdf_document: default
    toc: true
  html_document: default
    toc: true
editor_options:
  chunk_output_type: console
---

# Identify cases of TBI for further analysis

```{r setup, include=FALSE}
rm(list = ls())
library(lubridate)
library(gt)
library(arsenal)
library(kableExtra)
library(tidyverse)
knitr::opts_chunk$set(echo = TRUE,cache = TRUE, message= FALSE, results = 'hide')
```

# Read in data

```{r}

TBI_w <- readRDS('data/TBI_w.Rds')
Dictionary <- readRDS('data/Dictionary.Rds')

```

Order the dictionary correctly, and add the Row number as a variable

```{r}

Dictionary <- Dictionary %>%
  arrange(ICD_code) %>%
  mutate(Row = row_number())

```

# Plan

We start with `r length(TBI_w$ID) ` cases available for analysis. These are all hospital discharges with codes in S00 to S99 from 2013 to late 2020.

The aim is to reduce these to the TBI cases, but there is no specific TBI code in ICD10, so we follow an algorithm from previous work in New South Wales - 

Pozzato I, Tate RL, Rosenkoetter U, Cameron ID. Epidemiology of hospitalised traumatic brain injury in the state of New South Wales, Australia: a population-based study. Australian and New Zealand Journal of Public Health [Internet]. 2019 [cited 2021 Feb 2];43(4):382â€“8. Available from: https://onlinelibrary.wiley.com/doi/abs/10.1111/1753-6405.12878


# Proc codes
These are all the Procedure 1 codes used.

```{r}
Proc_codes <- TBI_w %>%
  select(Proc_1_ACHI_code, Proc_1_ACHI_name) %>%
  group_by(Proc_1_ACHI_code, Proc_1_ACHI_name) %>%
  summarise (N=n())

```

# CCS-IM codes

```{r}
DX_CCS_IM <- TBI_w %>%
  select(Dx_1_group_CCS_IM, Dx_1_name_CCS_IM) %>%
  group_by(Dx_1_group_CCS_IM, Dx_1_name_CCS_IM) %>%
  summarise (N=n())

```

# DRG codes, results = 'show'

```{r}
DRG_codes <- TBI_w %>%
  select(DRG_code, DRG_name) %>%
  group_by(DRG_code, DRG_name) %>%
  summarise(N = n()) %>%
  arrange(desc(N))

```

# Record selection

The primary selection was that all records with any code in S00 to S99 were included.

Focussing further on these, and following Pazzato et al. we focus on people with a skull fracture, a recorded intracranial injury, or a crush injury to the head. All cases with one or more of these codes, where an external cause of injury was coded were included. This gives us `r TBI_w %>% filter((Skull | IC_injury) & External)  %>% summarize(N=n())` cases immediately eligible.

```{r, results = 'asis'}
T1 <- tableby(External ~ Skull + IC_injury, data=TBI_w, test=FALSE, total=FALSE)

 summary(T1,text=TRUE)
```

Breaking these down more explicitly we get this :-

```{r, results = 'show'}
TBI_w %>% filter(Skull )  %>% summarize(N=n())
TBI_w %>% filter(IC_injury)  %>% summarize(N=n())

TBI_w %>% filter(Skull & IC_injury)  %>% summarize(N=n())
TBI_w %>% filter(Skull | IC_injury)  %>% summarize(N=n())

TBI_w %>% filter((Skull | IC_injury) & External)  %>% summarize(N=n()) # These are our key group

TBI_w %>% filter((Skull) & !External)  %>% summarize(N=n()) # These have no external cause identified.
TBI_w %>% filter((IC_injury) & !External)  %>% summarize(N=n()) # These have no external cause identified.
TBI_w %>% filter((Skull & IC_injury) & !External)  %>% summarize(N=n()) # These have no external cause identified.
TBI_w %>% filter((Skull | IC_injury) & !External)  %>% summarize(N=n()) # These have no external cause identified.
```

## LOC

The next group to look at are those with LOC, but no External cause.

```{r}
TBI_w %>% filter((LOC | PTA) & External)  %>% summarize(N=n())
TBI_w %>% filter((Skull | IC_injury)) %>% filter((LOC | PTA))  %>% summarize(N=n()) 

TBI_w %>% filter((Skull | IC_injury)) %>% filter((LOC | PTA)) %>% filter(External)  %>% summarize(N=n()) # These have an external cause identified.
TBI_w %>% filter((Skull | IC_injury)) %>% filter((LOC | PTA)) %>% filter(!External)  %>% summarize(N=n()) # These have no external cause identified.

TBI_w %>% filter((LOC | PTA) & External)  %>% summarize(N=n()) # 11312
TBI_w %>% filter((LOC | PTA) & !External)  %>% summarize(N=n()) # 1047 No external cause given
TBI_w %>% filter((LOC | PTA) & !External & Undetermined)  %>% summarize(N=n()) # 17 Undetermined intent
TBI_w %>% filter((LOC | PTA) & !External & Selfharm)  %>% summarize(N=n()) # 48 Self harm

TBI_w %>% filter((LOC | PTA) & !External & !Selfharm)  %>% summarize(N=n()) # 999
TBI_w %>% filter((LOC | PTA) & !External & !Selfharm & !Undetermined)  %>% summarize(N=n()) # 982
TBI_w %>% filter((LOC | PTA) & !External & !Selfharm & !Undetermined & !Syncope)  %>% summarize(N=n()) # 625
TBI_w %>% filter((LOC | PTA) & !External & !Selfharm & !Undetermined & !Syncope & !(Skull | IC_injury))  %>% summarize(N=n()) # 4

# A check file is prepared
# These have LOC/PTA but no external cause given, and no indication of intent or syncope
ToBeChecked1 <- TBI_w %>% filter((LOC | PTA) & !External & !Selfharm & !Undetermined & ! Syncope)  %>% #summarize(N=n())
  select(ID:PTAn,Dx_1_name_CCS_IM, Dx_1_group_CCS_IM, Proc_1_ACHI_code, Proc_1_ACHI_name, Proc_1_group_RCs, Proc_1_name_RCs, DRG_name, DRG_code, ICD_name_Dx_1:ICD_name_Dx_30) # 625 cases

ToBeChecked1 %>% filter(Proc_1_name_RCs == 'No proc 1') %>% summarize(N= n()) # 352 had no primary procedure
ToBeChecked1 %>% filter(Proc_1_name_RCs != 'No proc 1') %>% summarize(N= n()) # 273 had a procedure


write_csv(ToBeChecked1,'data/ToBeChecked1.csv')
```


```{r, results = 'asis'}

pander::pander(ToBeChecked1 %>% group_by(Proc_1_group_RCs) %>% summarize(N= n()) %>% arrange(desc(N)) %>% print(n = Inf))
```


#Read back in the manually amended files.
These cases, where there is no external code identified, but there is LOC or PTA, are manually reviewed to identify missed TBI cases.

```{r}
ToBeCheckedRevised1 <- readxl::read_xlsx('data/ToBeCheckedRevised1.xlsx')
Note1 <- ToBeCheckedRevised1 %>% select(ID,E_MRN, Manual_check, Note, Detail, External_detail) %>%
  mutate(Detail_lump = fct_lump_n(Detail,6))

TBI_w <- TBI_w %>%
  left_join(Note1,  by = c("ID", "E_MRN"))

table(Note1$Note)
table(Note1$Detail_lump)
table(Note1$Extermal_detail)
table(Note1$Note, Note1$Detail_lump)
table(Note1$Note, Note1$External_detail)
table(Note1$Detail_lump, Note1$External_detail)

```


The cases of loss-of-consciousness without an external cause given were manually reviewed. They fell into several distinct groups. There were `r ToBeChecked1 %>% filter(Proc_1_name_RCs != 'No proc 1') %>% summarize(N= n())` who had had a procedure of some kind, and `r ToBeChecked1 %>% filter(Proc_1_name_RCs == 'No proc 1') %>% summarize(N= n())` who had not. The range of procedures involved was very wide, but the two largest groups were 'No procedure', and 'Allied health interventions'.

```{r, results = 'asis'}
pander::pander(table(Note1$Note))
pander::pander(table(Note1$Detail))
pander::pander(table(Note1$External_detail))
pander::pander(table(Note1$Note, Note1$Detail))
pander::pander(table(Note1$Note, Note1$Detail_lump))
pander::pander(table(Note1$Note, Note1$External_detail))
pander::pander(table(Note1$Detail, Note1$External_detail))
pander::pander(table(Note1$Detail_lump, Note1$External_detail))

```

On manual checking they fell into 4 groups, as shown in the table. A small number had codes strongly suggesting traumatic brain injury, but had no identified external cause given. The largest group had no identifiable cause coded for the loss of consciousness. Many had a code recorded, for example, epilepsy, cardiac arrythmia, stroke, or acute MI, which seemed likely to explain their LOC. A proportion had other trauma, often a purely facial trauma, a nasal fracture, or a fractured jaw or tooth.

## Skull fracture or Intracranial injury recorded

The second set of cases for further consideration as to eligibility, or otherwise, are those where there is no external code, but where either a Skull fracture (n = `r TBI_w %>% filter((Skull) & !External)`), an intra-cranial injury (n = `r TBI_w %>% filter((IC_injury) & !External`), or both (n = `r TBI_w %>% filter((Skull & IC_injury) & !External)  %>% summarize(N=n())`), is recorded. This gives us a total of `r TBI_w %>% filter((Skull | IC_injury) & !External)  %>% summarize(N=n())` cases to be considered.

There are `r TBI_w %>% filter((Skull | IC_injury) & !External & Selfharm)  %>% summarize(N=n())` cases with codes recording self harm. 
There are `r TBI_w %>% filter((Skull | IC_injury) & !External & !Selfharm & Syncope)  %>% summarize(N=n())` cases with codes recording syncope. 
There are `r TBI_w %>% filter((Skull | IC_injury) & !External & !Selfharm & !is.na(Note))  %>% summarize(N=n())` cases with codes which have already been manually checked examined in the previous section. 

There are `r TBI_w %>% filter((Skull | IC_injury) & !External & !Selfharm & is.na(Note))  %>% summarize(N=n())` cases with codes which have already been manually checked examined in the previous section. 


```{r}
TBI_w %>% filter((Skull | IC_injury) & !External & Selfharm)  %>% summarize(N=n()) # 170
TBI_w %>% filter((Skull | IC_injury) & !External & Assaults)  %>% summarize(N=n()) # 0
TBI_w %>% filter((Skull | IC_injury) & !External & !Assaults & !Selfharm)  %>% summarize(N=n()) # 1775
TBI_w %>% filter((Skull | IC_injury) & !External & !Assaults & !Selfharm & !Syncope)  %>% summarize(N=n()) # 1388
TBI_w %>% filter((Skull | IC_injury) & !External & !Assaults & !Selfharm & !is.na(Note))  %>% summarize(N=n()) # 551
TBI_w %>% filter((Skull | IC_injury) & !External & !Assaults & !Selfharm & is.na(Note))  %>% summarize(N=n()) # 1224
TBI_w %>% filter((Skull | IC_injury) & !External & !Assaults & !Selfharm & !Syncope & !is.na(Note))  %>% summarize(N=n()) # 551
TBI_w %>% filter((Skull | IC_injury) & !External & !Assaults & !Selfharm & !Syncope & is.na(Note))  %>% summarize(N=n()) # 837

# A check file is prepared
ToBeChecked2 <- TBI_w %>% filter((Skull | IC_injury) & !External & !Assaults & !Selfharm & !Syncope & is.na(Note))  %>%
  select(ID:PTAn,Dx_1_name_CCS_IM, Dx_1_group_CCS_IM, Proc_1_ACHI_code, Proc_1_ACHI_name, Proc_1_group_RCs, Proc_1_name_RCs, Manual_check, Note, Detail, External, DRG_name, DRG_code, ICD_name_Dx_1:ICD_name_Dx_30, ICD_code_Dx_1:ICD_code_Dx_30)

write_csv(ToBeChecked2,'data/ToBeChecked2.csv')

ToBeChecked2 %>% select(Dx_1_group_CCS_IM, Dx_1_name_CCS_IM) %>% group_by(Dx_1_group_CCS_IM, Dx_1_name_CCS_IM) %>% summarize(N = n()) %>% arrange(desc(N))
ToBeChecked2 %>% select(DRG_code, DRG_name) %>% group_by(DRG_code, DRG_name) %>% summarize(N = n()) %>% arrange(desc(N))
ToBeChecked2 %>% select(Proc_1_ACHI_code, Proc_1_ACHI_name) %>% group_by(Proc_1_ACHI_code, Proc_1_ACHI_name) %>% summarize(N = n()) %>% arrange(desc(N))

```

There are a total of  `r TBI_w %>% filter((Skull | IC_injury) & !External & !Selfharm & !Syncope & is.na(Note))  %>% summarize(N=n())` cases which required further manual examination. These are cases recorded as having a skull fracture or an intracranial injury, who have no external code, no indication of self-harm, assault, syncope, and which were not manually checked when cases with LOC were checked.


```{r}

# Extensive manual checking suggests the following
# Leave out if CCS_IM group not Injury & Poisoning
# Leave out if CCS_IM name not Fracture skull & face or Intracranial injury
#
ToBeChecked2 %>%
  select(Dx_1_name_CCS_IM, Dx_1_group_CCS_IM) %>%
  group_by(Dx_1_name_CCS_IM, Dx_1_group_CCS_IM) %>%
  filter(Dx_1_group_CCS_IM == 'Injury & poisoning') %>%
  filter(Dx_1_name_CCS_IM == 'Fracture skull & face' | Dx_1_name_CCS_IM == 'Intracranial injury') %>%
  summarise(N = n()) %>% arrange( desc(N))

ToBeChecked2 %>%
  select(Dx_1_name_CCS_IM, Dx_1_group_CCS_IM) %>%
  group_by(Dx_1_name_CCS_IM, Dx_1_group_CCS_IM) %>%
  filter(Dx_1_group_CCS_IM == 'Injury & poisoning') %>%
  filter(Dx_1_name_CCS_IM == 'Fracture skull & face' | Dx_1_name_CCS_IM == 'Intracranial injury') %>%
  summarise(N = n()) %>% arrange( desc(N))

# Further manual checking suggests that cases can be discarded if
#  their Clinical classification group is not 'Injury & Poisoning', and their subgroup is not either 
#  'Fracture skull & face' or 'Intracranial injury')
# Cases where care was provided by other speciality groups were reviewed manually, and those grouped as
# 'Cardiology', 'Haematology', 'Endoscope', 'Not mapped proc 1', 'Anaesthetic & pain relief', 'Maxilliofacial & dental',
# 'Respiratory medicine',  'Otolaryngology', 'Urology ', 'Oncology', 'Vascular', 'Plastic surgery',
# 'Trauma orthopaedic other surgery', and 'Imaging and testing' were omitted.
# Finally remaining questionable cases where no LOC was recorded were omitted.
# All cases reporting post-traumatic amnesia were included.
#
ToBeChecked2 %>% # 1629
  ungroup() %>%
  filter(Dx_1_group_CCS_IM == 'Injury & poisoning') %>% # 977
  filter(Dx_1_name_CCS_IM == 'Fracture skull & face' | Dx_1_name_CCS_IM == 'Intracranial injury') %>% # 864
  filter(Proc_1_group_RCs %in% c('No proc 1', 'Medical interventions', 'Allied health interventions',
                                 'Neurosurgery','Paediatric medicine', 'Non surgery')) %>%  # 741
# Omit the following c('Cardiology', 'Haematology', 'Endoscope', 'Not mapped proc 1', 'Anaesthetic & pain relief',
#                       'Maxilliofacial & dental', 'Respiratory medicine',  'Otolaryngology', 'Urology ', 'Oncology',
#                       'Vascular', 'Plastic surgery', 'Trauma orthopaedic other surgery', 'Imaging and testing')
  filter(DRG_code != 'B80Z' & DRG_code != 'D04A') %>% # 336 Other loss of consciousness, Maxillary surgery
  filter(LOC | PTA) %>% #27
  select(Dx_1_name_CCS_IM, Dx_1_group_CCS_IM, DRG_code)

```

There are a total of  `r TBI_w %>% filter((Skull | IC_injury) & !External & !Selfharm & !Syncope & is.na(Note))  %>% summarize(N=n())` cases which required further manual examination. These are cases recorded as having a skull fracture or an intracranial injury, who have no external code, no indication of self-harm, assault, syncope, and which were not manually checked when cases with LOC were checked.

```{r}
ToBeCheckedRevised2 <- readxl::read_xlsx('data/ToBeCheckedRevised2.xlsx')
Note2 <- ToBeCheckedRevised2 %>% select(ID,E_MRN, Manual_check, Note, Detail, External_detail) %>%
  mutate(Detail_lump = fct_lump_n(Detail,8))

TBI_w <- TBI_w %>%
  left_join(Note2,  by = c("ID", "E_MRN"))

table(Note1$Note)
table(Note2$Note)
table(Note1$Detail_lump)
table(Note2$Detail_lump)
table(Note1$External_detail)
table(Note2$External_detail)

table(Note2$Note, Note2$Detail)
table(Note2$Note, Note2$Detail_lump)

```


Of the cases derived from manual checking a small number are likely to be traumatic brain injuries, but have had no valid external cause codes provided. For a small number codes are given which suggest a location or a mechanism of injury It's not possible


```{r, results = 'asis'}
pander::pander(table(Note1$Note))
pander::pander(table(Note2$Note))
pander::pander(table(Note1$Detail))
pander::pander(table(Note2$Detail))
pander::pander(table(Note1$External_detail))
pander::pander(table(Note2$External_detail))
pander::pander(table(Note1$Note, Note1$Detail))
pander::pander(table(Note2$Note, Note2$Detail))
pander::pander(table(Note1$Note, Note1$Detail_lump))
pander::pander(table(Note2$Note, Note2$Detail_lump))
pander::pander(table(Note1$Note, Note1$External_detail))
pander::pander(table(Note2$Detail_lump, Note2$External_detail))

```

Produce the working file


```{r, results = 'show'}
TBI_final<- TBI_w %>%
  filter((Skull | IC_injury | PTA) & External)
  
summary(tableby(External ~ Skull +IC_injury, data=TBI_final, test=FALSE, total=FALSE),text=TRUE)

```


#Save the data files for further work

```{r}
saveRDS(TBI_final, file='data/TBI_final.Rds')

```
